<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨ç›£æ§ç³»çµ±</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦å´é¢æ¿ */
        .sidebar {
            width: 280px;
            background: #2d2d2d;
            padding: 15px;
            border-right: 2px solid #404040;
            overflow-y: auto;
        }

        .sidebar h1 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #b0b0b0;
            font-size: 13px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
            resize: vertical;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .price-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-start {
            background: #4CAF50;
            color: white;
            margin-bottom: 10px;
        }

        .btn-start:hover {
            background: #45a049;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-stop:hover {
            background: #da190b;
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
            font-size: 13px;
        }

        .help-text {
            margin-top: 6px;
            font-size: 11px;
            color: #888;
        }

        /* ä¸»è¦å…§å®¹å€ */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #404040;
        }

        .header h2 {
            color: #4CAF50;
        }

        .last-update {
            color: #888;
            font-size: 14px;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #404040;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #4CAF50;
            border-bottom: 2px solid #505050;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #404040;
        }

        tbody tr:hover {
            background: #353535;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
        }

        .positive {
            color: #f44336;
        }

        .negative {
            color: #4CAF50;
        }

        .ticker {
            font-weight: bold;
            color: #4CAF50;
        }

        .vol-ratio {
            font-weight: bold;
            color: #2196F3;
        }

        /* é‡ç›¸é—œæ¬„ä½èƒŒæ™¯ */
        .vol-column {
            background: rgba(33, 150, 243, 0.25);
            white-space: nowrap;
            max-width: 200px;
        }

        /* åƒ¹ç›¸é—œæ¬„ä½èƒŒæ™¯ */
        .price-column {
            background: rgba(255, 152, 0, 0.25);
            white-space: nowrap;
            max-width: 200px;
        }

        /* 0% é¡¯ç¤ºç™½è‰² */
        .zero-value {
            color: #e0e0e0 !important;
        }

        /* æ–°å¢è³‡æ–™å‹•ç•« */
        @keyframes highlight {
            0% { background: #4CAF50; }
            100% { background: transparent; }
        }

        tr.new-row {
            animation: highlight 1s ease-out;
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #404040;
                max-height: 50vh;
            }

            .sidebar h1 {
                font-size: 18px;
                margin-bottom: 10px;
            }

            textarea {
                min-height: 80px;
                font-size: 12px;
            }

            .main-content {
                padding: 10px;
                overflow-x: auto;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 6px 4px;
            }

            .vol-column, .price-column {
                font-size: 10px;
                max-width: 140px;
            }

            .ticker, .vol-ratio {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="sidebar">
            <h1>ğŸ“Š è‚¡ç¥¨ç›£æ§ç³»çµ±</h1>

            <div class="input-group">
                <label>è‚¡ç¥¨ä»£ç¢¼ (æ¯è¡Œä¸€å€‹)</label>
                <textarea id="tickerInput" placeholder="ä¾‹å¦‚:&#10;2330&#10;2454&#10;2317">2408
2337
3260</textarea>
                <div class="help-text">* æ¯è¡Œè¼¸å…¥ä¸€å€‹è‚¡ç¥¨ä»£ç¢¼</div>
            </div>

            <div class="input-group">
                <label>è‚¡åƒ¹ç¯„åœ</label>
                <div class="price-range">
                    <div>
                        <label style="font-size: 12px;">æœ€ä½åƒ¹</label>
                        <input type="number" id="minPrice" value="0" min="0">
                    </div>
                    <div>
                        <label style="font-size: 12px;">æœ€é«˜åƒ¹</label>
                        <input type="number" id="maxPrice" value="250" min="0">
                    </div>
                </div>
            </div>

            <button class="btn btn-start" id="startBtn" onclick="startMonitoring()">é–‹å§‹ç›£æ§</button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopMonitoring()" disabled>åœæ­¢ç›£æ§</button>

            <div class="status" id="status">
                ç­‰å¾…å•Ÿå‹•...
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="main-content">
            <div class="header">
                <h2>å³æ™‚ç›£æ§æ•¸æ“š</h2>
                <div class="last-update" id="lastUpdate">å°šæœªæ›´æ–°</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ä»£ç¢¼</th>
                        <th>åç¨±</th>
                        <th>åƒ¹æ ¼</th>
                        <th>æ¼²å¹…%</th>
                        <th>é‡/5MA</th>
                        <th class="vol-column">é‡å‹•èƒ½30"/1'/2'</th>
                        <th class="price-column">åƒ¹å‹•èƒ½30"/1'/2'</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <tr>
                        <td colspan="11" class="no-data">è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ä¸¦é–‹å§‹ç›£æ§</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const socket = io();
        let isMonitoring = false;

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åœæ­¢ç›£æ§
        window.addEventListener('load', async function() {
            try {
                // é é¢è¼‰å…¥æ™‚è‡ªå‹•å‘¼å«åœæ­¢ API
                await fetch('/api/stop', { method: 'POST' });

                // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('status').textContent = 'ç­‰å¾…å•Ÿå‹•...';
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('status').textContent = 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨';
            }
        });

        // ç›£è½ WebSocket æ›´æ–°
        socket.on('update', function(data) {
            updateTable(data.data);
            document.getElementById('lastUpdate').textContent = 'æœ€å¾Œæ›´æ–°: ' + data.time;
        });

        socket.on('status', function(data) {
            document.getElementById('status').textContent = data.message;
        });

        // é–‹å§‹ç›£ï¿½ï¿½
        async function startMonitoring() {
            const tickerText = document.getElementById('tickerInput').value.trim();
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 999999;

            if (!tickerText) {
                alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            const tickers = tickerText.split('\n')
                .map(t => t.trim())
                .filter(t => t.length > 0);

            document.getElementById('status').textContent = 'æ­£åœ¨å•Ÿå‹•ç›£æ§...';
            document.getElementById('startBtn').disabled = true;

            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tickers: tickers,
                        min_price: minPrice,
                        max_price: maxPrice
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    isMonitoring = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('status').textContent = `ç›£æ§ä¸­ (${result.tickers_count} æ”¯è‚¡ç¥¨)`;
                } else {
                    alert(result.message);
                    document.getElementById('startBtn').disabled = false;
                }
            } catch (error) {
                alert('å•Ÿå‹•å¤±æ•—: ' + error);
                document.getElementById('startBtn').disabled = false;
            }
        }

        // åœæ­¢ç›£æ§
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    isMonitoring = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('status').textContent = result.message;
                }
            } catch (error) {
                alert('åœæ­¢å¤±æ•—: ' + error);
            }
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable(data) {
            const tbody = document.getElementById('dataTable');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                // æ ¼å¼åŒ–é‡æ•¸æ“š
                const volClass30 = item.vol_diff_30sec == 0 ? 'zero-value' : (item.vol_diff_30sec >= 0 ? 'positive' : 'negative');
                const volClass1 = item.vol_diff_1min == 0 ? 'zero-value' : (item.vol_diff_1min >= 0 ? 'positive' : 'negative');
                const volClass2 = item.vol_diff_2min == 0 ? 'zero-value' : (item.vol_diff_2min >= 0 ? 'positive' : 'negative');

                const vol30 = `<span class="${volClass30}">${item.vol_diff_30sec >= 0 ? '+' : ''}${item.vol_diff_30sec}%</span>`;
                const vol1 = `<span class="${volClass1}">${item.vol_diff_1min >= 0 ? '+' : ''}${item.vol_diff_1min}%</span>`;
                const vol2 = `<span class="${volClass2}">${item.vol_diff_2min >= 0 ? '+' : ''}${item.vol_diff_2min}%</span>`;

                // æ ¼å¼åŒ–åƒ¹æ•¸æ“š
                const priceClass30 = item.price_diff_30sec == 0 ? 'zero-value' : (item.price_diff_30sec >= 0 ? 'positive' : 'negative');
                const priceClass1 = item.price_diff_1min == 0 ? 'zero-value' : (item.price_diff_1min >= 0 ? 'positive' : 'negative');
                const priceClass2 = item.price_diff_2min == 0 ? 'zero-value' : (item.price_diff_2min >= 0 ? 'positive' : 'negative');

                const price30 = `<span class="${priceClass30}">${item.price_diff_30sec >= 0 ? '+' : ''}${item.price_diff_30sec}%</span>`;
                const price1 = `<span class="${priceClass1}">${item.price_diff_1min >= 0 ? '+' : ''}${item.price_diff_1min}%</span>`;
                const price2 = `<span class="${priceClass2}">${item.price_diff_2min >= 0 ? '+' : ''}${item.price_diff_2min}%</span>`;

                return `
                    <tr class="new-row">
                        <td class="ticker">${item.ticker}</td>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td class="${item.pct_change >= 0 ? 'positive' : 'negative'}">
                            ${item.pct_change >= 0 ? '+' : ''}${item.pct_change}%
                        </td>
                        <td class="vol-ratio">${item.vol_ratio}%</td>
                        <td>${vol30}<span class="zero-value"> / </span>${vol1}<span class="zero-value"> / </span>${vol2}</td>
                        <td>${price30}<span class="zero-value"> / </span>${price1}<span class="zero-value"> / </span>${price2}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
